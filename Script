// ==UserScript==
// @name         ADAPT Helper for L4+ Ops
// @namespace    http://tampermonkey.net/
// @version      3.4
// @descescription  Assists L4+ Ops leaders in creating standardized ADAPT documentation
// @author       @thifanym
// @match        https://adapt-dub.amazon.com/*
// @grant        GM_addStyle
// @updateURL    https://raw.githubusercontent.com/Thifanym/Adapt-Helper-/refs/heads/main/Script
// @downloadURL  https://raw.githubusercontent.com/Thifanym/Adapt-Helper-/refs/heads/main/Script
// ==/UserScript==

(function() {
    'use strict';

    GM_addStyle(`
        .adapt-helper-modal, .adapt-content-modal {
            position: fixed;
            top: 50px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 10000;
            width: 400px;
            font-family: Arial, sans-serif;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .adapt-content-modal {
            width: 600px;
        }
        .adapt-helper-title {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .adapt-helper-form {
            display: grid;
            gap: 10px;
        }
        .adapt-helper-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .adapt-helper-form input,
        .adapt-helper-form select,
        .adapt-helper-form textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .adapt-helper-button {
            background: #00A8E1;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .adapt-helper-button:hover {
            background: #0088B4;
        }
        .adapt-helper-close {
            position: absolute;
            right: 10px;
            top: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }
        .request-feature-icon {
            position: absolute;
            right: 40px;
            top: 10px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }
        .warning-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        #adapt-helper-float {
            position: fixed;
            top: 40px;
            right: 10px;
            z-index: 9999;
        }
        .generated-content {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    `);

    const BEHAVIOUR_CATEGORIES = {
        behavioural: [
                       "Break timing violations",
            "Cherry picking",
            "Clock-in/out timing violations",
            "Dress code/grooming violations",
            "Food/beverage on work floor",
            "Inappropriate language/communication",
            "Insubordination/refusal to work",
            "Mobile phone/headphone usage",
            "Overfilled totes",
            "Refusal to show badge",
            "Standard Work",
            "Thank you!",
            "Time off task/idleness under 90 minutes",
            "Unpaid break clock-out failures",
            "Working time violations",
            "Workstation cleanliness"

        ],
        safety: [
            "Mobile phone use whilst operating equipment",
            "PIT/Tug violations",
            "TDR policy breaches",
            "Not wearing PPE in restricted zone",
            "Serious safety breaches"
        ]
    };

    const LOCATIONS = [
        "AFE",
        "Pack Singles",
        "PCNS",
        "Pick",
        "Stow",
        "Ship Dock",
        "Receive",
        "ICQA",
        "IB Dock",
        "P2R",
        "Outside of permitted areas",
        "Other (specify)"
    ];

    const FEEDBACK_LEVELS = [
        "Supportive Conversation",
        "Conversation",
        "Counselling",
        "First Written Conversation",
        "Second Written Conversation",
        "Final Written Conversation",
        "Documented Positive",
        "Feedback"
    ];

    const ESCALATED_BEHAVIOURS = [
        "Inappropriate language/communication",
        "Insubordination/refusal to work",
        "Serious safety breaches"
    ];

    const ADAPT_TEMPLATES = {
        "Mobile phone/headphone usage": {
            template: (data) => ({
                details: `Misconduct: Unreasonable and / or unauthorised use of mobile phones
STU completed by: ${data.stuHeldBy}

On ${data.date} at ${data.time}, you were observed using your mobile phone in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}Mobile phone use in working areas can create safety hazards and may also risk exposure of confidential, customer, proprietary, or other sensitive business information.

Based the discussion held by ${data.stuHeldBy}, you stated that ${data.aaSTU}. This is a violation of our Mobile Phone Policy and you are receiving this ${data.feedbackLevel}.`,
                improvement: `Areas of Improvement:
Safety is our top priority and must remain at the forefront of everything you do. As stated in the Mobile Phone Policy, Category Two offenses are considered serious and generally result in progressive discipline. Infractions may include:
(1) Mobile phone use while performing work tasks and walking
(2) Use of earbuds or headphones
(3) Use of a mobile phone to play games, music, videos, etc. outside of approved break areas

Moving forward, you must ensure that you are following Amazon's Mobile Phone Policy. Future instances of violations may result in further corrective action, up to and including termination of employment.`
            })
        },
        "Standard Work": {
            template: (data) => ({
                details: `Misconduct: Failure to follow standard Work practices

On ${data.date}, you failed to follow appropriate standard work practices. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}${data.aaSTU}.`,
                improvement: `As detailed above, you have failed to meet Amazon's Standards of Conduct and behavioural expectations. Amazon expects associates to adhere to standard operating procedures with regards to processing orders in each function within the FC. Failure to adhere to standard work guidelines includes, but is not limited to, any action that artificially inflates an individual's rate (i.e. double-scanning, machine-gunning), dishonest behaviour or discriminatory work selection that directly or indirectly hinders others' performance (i.e. cherry picking), knowingly causing a virtual/physical mismatch, or circumventing critical steps in the process/PMV. Failure to meet these expectations and/or future violations of these guidelines may result in additional discipline, up to and including termination.`
            })
        },
        "Time off task/idleness under 90 minutes": {
            template: (data) => ({
                details: `Misconduct: Time off task/idleness

On ${data.date}, you had a total of ${data.idleTime} minutes of unknown idle time. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}${data.stuHeldBy} held a seek to understand conversation with you to follow up on the reason(s) for this time off task. You identified barriers including ${data.aaSTU}. Based on your explanation, the manager validated that during this time, you were not actively engaged in a work process for reasons within your control. This behaviour violates Amazon's Standards of Conduct, and therefore you are receiving this ${data.feedbackLevel}.`,
                improvement: `To work together successfully as a team, we need your partnership. As an Amazon employee, we expect you to come to work and give your best effort each day. This means working safely, following standard work, positively contributing to the team, staying actively engaged in your assigned task, communicating barriers, and requesting additional training or support when you need it. Amazon expects you to remain productive during your scheduled shift. In the event you are logged off software tools for a prolonged time, notify a manager so they can assist in addressing any job-related barriers. Further incidents of idle time within your control will lead to additional discipline, up to and including termination of employment.`
            })
        },
        "Break timing violations": {
            template: (data) => ({
                details: `Misconduct: Extended break/Break timing violations

On ${data.date}, you ha had an extended ${data.breakNumber} break on shift. Your break lasted ${data.breakTime} minutes. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}During STU conversation with ${data.stuHeldBy}, you identified barriers including ${data.aaSTU}. It is important to remain productive at Amazon by leaving for and returning from breaks at the correct time. Based on the discussion, you did not provide reasonable mitigations and therefore you are receiving this ${data.feedbackLevel}.`,
                improvement: `Going forward, you are expected to leave and come back from breaks and lunches on time and remain on task while performing any function. You are required to remain productive during your scheduled shift which includes leaving your work area at your assigned break/lunch start time and arriving back in your work area ready to work by the end of your break/lunch end time. If you have any barriers or concerns please notify your Leadership immediately. Further incidents of unproductive time may lead to further corrective action up to and including termination of employment.`
            })
        },
        "Food/beverage on work floor": {
            template: (data) => ({
                details: `Misconduct: Food/Beverage on shop Floor

On ${data.date}, you were observed with food/drink while on the FC floor. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}A seek to understand conversation took place with ${data.stuHeldBy} and yourself on ${data.date} to which you stated ${data.aaSTU}. Water is the only food or beverage allowed on the FC floor. Having food or drink (besides water) on the FC floor is considered a violation of the Standards of Conduct, specifically "Creating or contributing to disorderly or unsanitary conditions.". You are therefor receiving this ${data.feedbackLevel}. `,
                improvement: `Moving forward, you are only permitted to have clear water in a clear bottle with a secured top on the floor. Future violations of Amazon's Standards of Conduct will result in further corrective action, up to and including termination.`
            })
        },
        "Cherry picking": {
            template: (data) => ({
                details: `Misconduct: Cherry Picking

On ${data.date}, you were observed cherry picking while performing work in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}A seek to understand conversation with ${data.stuHeldBy} took place with you to which you stated ${data.aaSTU}. Cherry picking is against standard work and creates an unfair condition for other associates. You were informed of expectations going forward and notified of this ${data.feedbackLevel}.`,
                improvement: `As detailed above, you have failed to meet Amazon's Standards of Conduct and behavioural expectations. Amazon expects associates to adhere to standard operating procedures with regards to processing orders in each function within the FC. Failure to adhere to standard work guidelines includes, but is not limited to, any action which artificially inflates an individual's rate (i.e. double-scanning, machine-gunning), dishonest behaviour or discriminatory work selection which ch directly or indirectly hinders others' performance (i.e. cherry picking), knowingly causing a virtual/physical mismatch, or circumventing critical steps in the process. Failure to meet these expectations and/or future violations of these guidelines may result in additional discipline, up to and including termination.`
            })
        },
        "Dress code/grooming violations": {
            template: (data) => ({
                details: `Misconduct: Dress code/grooming violations

On ${data.date}, you reported to work in violation of Amazon's Dress and Grooming Standards Policy. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}A seek to understand conversation with ${data.stuHeldBy} took place with you to which you stated ${data.aaSTU}. Amazon encourages Associates to wear casual and comfortable clothing, however, not all casual and comfortable clothing is appropriate or safe in our building. You are being addressed due to the safety risk to yourself and/or other associates created by violation of the Amazon Dress Code. You are therefor receiving this ${data.feedbackLevel}.`,
                improvement: `Immediate improvement and adherence to the Amazon's Dress and Grooming policy is required. Repeated violations of this policy will result in further corrective discipline up to and including termination.`
            })
        },
        "Working time violations": {
            template: (data) => ({
                details: `Misconduct: Working time violations

On ${data.date}, you worked over 12/60 hours. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}Although your hard work is appreciated, there was no operational reason why you should have worked over 12/60 hours. A seek to understand conversation took place with you to which you stated ${data.aaSTU}. We value your health and safety, therefore it is important that you follow the overtime policy as outlined in the attendance policy. This is a violation of Amazon Working Hour Policy: No employee is to work more than 12 hours per day, 60 hours per work week, or 6 consecutive days in a row.`,
                improvement: `Going forward, you are required to follow Amazon Policy. Associates will not be asked to, nor may they voluntarily, work more than 12 hours per day or more than 60 hours per week. You are responsible for managing your time so as not to exceed 12 hours worked per shift or 60 hours in a work week. If you believe there is a reason for you to work over the 12 hours, you should speak to your Leadership team. Violating Amazon's Working Hour Policy may result in further corrective action up to and including termination.`
            })
        },
        "Inappropriate language/communication": {
            template: (data) => ({
                details: `Misconduct: Inappropriate language/communication

On ${data.date}, you were observed using inappropriate language or communication. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}A seek to understand conversation with ${data.stuHeldBy} took place with you to which you stated }${data.aaSTU}. Based on the discussion, you did not provide reasonable mitigations for your behaviour and therefore you are receiving this ${data.feedbackLevel}.`,
                improvement: `Amazon expects all associates to maintain professional and respectful communication at all times. Inappropriate language, gestures, or actions create a negative work environment and are not tolerated. Future instances of such behaviour may result in further corrective action, up to and including termination of employment.`
            })
        },
        "Insubordination/refusal to work": {
            template: (data) => ({
                details: `Misconduct: Insubordination/refusal to work

On ${data.date}, you demonstrated insubordination or refused to work as directed. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}A seek to understand conversation with ${data.stuHeldBy} took place with you to which you stated }}${data.aaSTU}. Based on the discussion, you did not provide reasonable mitigations for your behaviour and therefore you are receiving this ${data.feedbackLevel}.`,
                improvement: `Amazon expects all associates to follow reasonable instructions from their supervisors and to perform their assigned duties. Insubordination or refusal to work undermines team effectiveness and productivity. Future instances of such behaviour may result in further corrective action, up to and including termination of employment.`
            })
        },
        "Mobile phone use whilst operating equipment": {
            template: (data) => ({
                details: `Misconduct: Mobile phone use whilst operating equipment

On ${data.date}, you were observed using a mobile phone while operating equipment in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}${data.aaSTU}.`,
                improvement: `The use of mobile phones while operating equipment is strictly prohibited due to the serious safety risks it poses. This behaviour is a violation of Amazon's safety policies. Future violations of this nature will result in further disciplinary action, up to and including termination of employment.`
            })
        },
        "PIT/Tug violations": {
            template: (data) => ({
                details: `Misconduct: PIT/Tug violations

On ${data.date}, you were observed violating PIT/Tug safety procedures in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}${data.aaSTU}.`,
                improvement: `PIT/Tug safety procedures are critical for maintaining a safe work environment. Violations of these procedures put you and your colleagues at risk. Adherence to all safety protocols is mandatory. Future violations will result in further disciplinary action, up to and including termination of employment.`
            })
        },
        "TDR policy breaches": {
            template: (data) => ({
                details: `Misconduct: TDR policy breaches

On ${data.date}, you were observed breaching TDR (Trailer Dock and Release) policy in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}${data.aaSTU}.`,
                improvement: `TDR procedures are crucial for the safety of all associates and the integrity of our operations. Strict adherence to TDR policies is required at all times. Any future breaches of TDR policy will result in further disciplinary action, up to and including termination of employment.`
            })
        },
        "Not wearing PPE in restricted zone": {
            template: (data) => ({
                details: `Misconduct: Not wearing PPE in restricted zone

On ${data.date}, you were observed not wearing the required Personal Protective Equipment (PPE) in a restricted zone in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}${data.aaSTU}.`,
                improvement: `Wearing appropriate PPE in restricted zones is mandatory for your safety and the safety of others. Failure to do so is a serious violation of Amazon's safety policies. Future instances of not wearing required PPE will result in further disciplinary action, up to and including termination of employment.`
            })
        },
        "Serious safety breaches": {
            template: (data) => ({
                details: `Misconduct: Serious safety breaches

On ${data.date}, you were involved in a serious safety breach in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}${data.aaSTU}.`,
                improvement: `Safety is our top priority at Amazon. Serious safety breaches put you and your colleagues at significant risk and are not tolerated. This incident is a severe violation of our safety policies. Any future safety breaches of this nature will result in further disciplinary action, up to and including immediate termination of employment.`
            })
        },
        "Overfilled totes": {
            template: (data) => ({
                details: `Misconduct: Overfilling totes

On ${data.date}, it was found that you overfilled a tote while performing in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}A STU was held with you by ${data.stuHeldBy}, to which you stated ${data.aaSTU}. It is important that you fill the tote only to its capacity and not overflow it with items, in order to ensure that we prevent risk of injuries, conveyor jams, or items falling from the tote. You were informed of expectations going forward and notified of this ${data.feedbackLevel}.`,
                improvement: `Going forward, you are expected to follow all standard work guidelines to ensure efficient and fair work for all associates. Failure to comply with these expectations may result in additional disciplinary action up to and including termination.`
            })
        },
        "Workstation cleanliness": {
            template: (data) => ({
                details: `Misconduct: Failure to maintain workstation cleanliness

On ${data.date}, you failed to maintain your workstation according to Amazon's cleanliness standards in ${data.location}. ${data.incidentDetails ? `Specifically, ${data.incidentDetails}. ` : ''}A STU was held with you by ${data.stuHeldBy}, to which you stated ${data.aaSTU}. It is important that you keep your workstation clean. Maintaining clean workstations prevents safety hazards, improves operational efficiency, ensures the next associate can begin work immediately, and upholds our high standards for workplace conditions.

As detailed above, you have failed to meet this expectation. This behavior violates Amazon's Standards of Conduct, and therefore you are receiving this ${data.feedbackLevel}.`,
                improvement: `Going forward, you are expected to follow all standard work guidelines to ensure efficient and fair work for all associates. Failure to comply with these expectations may result in additional disciplinary action up to and including termination.`
            })
        },
        "Thank you!": {
            template: (data) => ({
                details: `Thank you for your dedication!

On ${data.date}, I was truly impressed by your work in ${data.location}. ${data.incidentDetails ? `You really stood out when you, ${data.incidentDetails}. ` : ''}${data.aaSTU}.`,
                improvement: `I want to personally thank you for bringing such dedication to your role. Your performance reflects not just professionalism, but genuine care for our standards of excellence at Amazon.`
            })
        }
    };

        const createHelperWindow = () => {
        const modal = document.createElement('div');
        modal.className = 'adapt-helper-modal';
        modal.innerHTML = `
            <div class="adapt-helper-title">Log Incident</div>
            <span class="adapt-helper-close">×</span>
            <span class="request-feature-icon" title="Request Feature/Ask Question">⚙️</span>
            <form class="adapt-helper-form">
                <div>
                    <label>Date:</label>
                    <input type="date" id="incident-date" required>
                </div>
                <div>
                    <label>Time:</label>
                    <input type="time" id="incident-time" required>
                </div>
                <div>
                    <label>Location:</label>
                    <select id="incident-location" required>
                        <option value="">Select location...</option>
                        ${LOCATIONS.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                    </select>
                    <input type="text" id="custom-location" style="display:none;" placeholder="Specify location">
                </div>
                <div>
                    <label>Category:</label>
                    <select id="incident-category" required>
                        <option value="">Select category...</option>
                        <option value="behavioural">Behavioural</option>
                        <option value="safety">Safety</option>
                    </select>
                </div>
                <div>
                    <label>Behaviour:</label>
                    <select id="behaviour-select" required>
                        <option value="">Select behaviour...</option>
                    </select>
                </div>
                <div>
                    <label>Feedback Level:</label>
                    <select id="feedback-level" required>
                        <option value="">Select feedback level...</option>
                        ${FEEDBACK_LEVELS.map(level => `<option value="${level}">${level}</option>`).join('')}
                    </select>
                </div>
                <div id="idle-time-input" style="display:none;">
                    <label>Idle Time (minutes):</label>
                    <input type="number" id="idle-time" min="0">
                </div>
                <div id="break-time-input" style="display:none;">
                    <label>Break Time (minutes):</label>
                    <input type="number" id="break-time" min="0">
                    <label>Break Number:</label>
                    <select id="break-number">
                        <option value="">Select break...</option>
                        <option value="first">First Break</option>
                        <option value="second">Second Break</option>
                    </select>
                </div>
                <div>
                    <label>STU held by:</label>
                    <input type="text" id="stu-held-by" required>
                </div>
                <div>
                    <label>Incident details:</label>
                    <input type="text" id="incident-details" placeholder="Optional">
                </div>
                <div>
                    <label>AA STU:</label>
                    <textarea id="aa-stu" rows="3" required></textarea>
                </div>
                <div id="warning-message" class="warning-message" style="display:none;"></div>
                <button type="submit" class="adapt-helper-button">Generate ADAPT</button>
            </form>
        `;
        return modal;
    };

    const updateBehaviourOptions = (category) => {
        const behaviourSelect = document.getElementById('behaviour-select');
        behaviourSelect.innerHTML = '<option value="">Select behaviour...</option>';

        BEHAVIOUR_CATEGORIES[category].forEach(behaviour => {
            const option = document.createElement('option');
            option.value = behaviour;
            option.textContent = behaviour;
            behaviourSelect.appendChild(option);
        });
    };

    const generateAdaptContent = (data) => {
        const template = ADAPT_TEMPLATES[data.behaviour];
        if (template) {
            return template.template(data);
        } else {
            return {
                details: `No template available for ${data.behaviour}. Please manually enter the details.`,
                improvement: 'No improvement area available.'
            };
        }
    };

    const showGeneratedContent = (content) => {
        const existingModal = document.querySelector('.adapt-content-modal');
        if (existingModal) {
            existingModal.remove();
        }

        const modal = document.createElement('div');
        modal.className = 'adapt-content-modal';
        modal.innerHTML = `
            <div class="adapt-helper-title">Generated ADAPT Content</div>
            <span class="adapt-helper-close">×</span>
            <h3>Detail of Incident</h3>
            <div id="generated-content-details" class="generated-content">${content.details}</div>
            <button class="adapt-helper-button" id="copy-details">Copy Details to Clipboard</button>
            <h3>Area of Improvement</h3>
            <div id="generated-content-improvement" class="generated-content">${content.improvement}</div>
            <button class="adapt-helper-button" id="copy-improvement">Copy Improvement to Clipboard</button>
        `;
        document.body.appendChild(modal);

        modal.querySelector('.adapt-helper-close').onclick = () => modal.remove();
        modal.querySelector('#copy-details').onclick = () => {
            navigator.clipboard.writeText(content.details).then(() => {
                alert('Details copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        };
        modal.querySelector('#copy-improvement').onclick = () => {
            navigator.clipboard.writeText(content.improvement).then(() => {
                alert('Improvement area copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        };
    };

    const initializeHelper = () => {
        const existingHelper = document.querySelector('.adapt-helper-modal');
        if (existingHelper) {
            existingHelper.remove();
        }

        const helper = createHelperWindow();
        document.body.appendChild(helper);

        const categorySelect = helper.querySelector('#incident-category');
        const behaviourSelect = helper.querySelector('#behaviour-select');
        const feedbackLevelSelect = helper.querySelector('#feedback-level');
        const warningMessage = helper.querySelector('#warning-message');
        const locationSelect = helper.querySelector('#incident-location');
        const customLocationInput = helper.querySelector('#custom-location');
        const idleTimeInput = helper.querySelector('#idle-time-input');
        const breakTimeInput = helper.querySelector('#break-time-input');

        helper.querySelector('.adapt-helper-close').onclick = () => helper.remove();

        helper.querySelector('.request-feature-icon').onclick = () => {
            const subject = encodeURIComponent('ADAPT Helper Feature Request/Question');
            const body = encodeURIComponent('Feature Request/Question Details:\n\n');
            window.location.href = `mailto:thifanym@amazon.co.uk?subject=${subject}&body=${body}`;
        };

        categorySelect.onchange = () => {
            behaviourSelect.innerHTML = '<option value="">Select behaviour...</option>';
            if (categorySelect.value) {
                updateBehaviourOptions(categorySelect.value);
            }
        };

        locationSelect.onchange = () => {
            if (locationSelect.value === 'Other (specify)') {
                customLocationInput.style.display = 'block';
            } else {
                customLocationInput.style.display = 'none';
            }
        };

        behaviourSelect.onchange = () => {
            if (ESCALATED_BEHAVIOURS.includes(behaviourSelect.value)) {
                feedbackLevelSelect.value = 'First Written Warning';
                warningMessage.textContent = 'This behaviour may require escalation. Please contact HR.';
                warningMessage.style.display = 'block';
            } else {
                warningMessage.style.display = 'none';
            }

            if (behaviourSelect.value === 'Time off task/idleness under 90 minutes') {
                idleTimeInput.style.display = 'block';
                breakTimeInput.style.display = 'none';
            } else if (behaviourSelect.value === 'Break timing violations') {
                idleTimeInput.style.display = 'none';
                breakTimeInput.style.display = 'block';
            } else {
                idleTimeInput.style.display = 'none';
                breakTimeInput.style.display = 'none';
            }
        };

        helper.querySelector('form').onsubmit = (e) => {
            e.preventDefault();
            const formData = {
                date: document.getElementById('incident-date').value,
                time: document.getElementById('incident-time').value,
                location: locationSelect.value === 'Other (specify)' ? customLocationInput.value : locationSelect.value,
                category: categorySelect.value,
                behaviour: behaviourSelect.value,
                feedbackLevel: feedbackLevelSelect.value,
                aaSTU: document.getElementById('aa-stu').value,
                stuHeldBy: document.getElementById('stu-held-by').value,
                incidentDetails: document.getElementById('incident-details').value,
                idleTime: document.getElementById('idle-time')?.value,
                breakTime: document.getElementById('break-time')?.value,
                breakNumber: document.getElementById('break-number')?.value
            };

            const content = generateAdaptContent(formData);
            showGeneratedContent(content);
        };
    };

    const createFloatingButton = () => {
        const button = document.createElement('button');
        button.id = 'adapt-helper-float';
        button.className = 'adapt-helper-button';
        button.textContent = 'ADAPT Helper';
        button.onclick = initializeHelper;
        document.body.appendChild(button);
    };

    const initialize = () => {
        createFloatingButton();
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();

